---
title: Architecture of this site
description: Architecture of this site
date: "2024-07-04T12:03:16+08:00"
publishDate: "2024-07-04T12:03:16+08:00"
---

# 1. Architecture Overview

Source code is available in https://github.com/mcnuggets-lab/cloud-project1.

This work is based on https://github.com/noahgift/dukehugofeb1, with some non-trivial modifications and added components to make it work better. Here I try to explain the architecture of this site using my own words.

The architecture looks like

![Hugo-CD](https://github.com/mcnuggets-lab/cloud-project1/assets/16054484/5366d72c-2149-43e9-8258-b7eaf6f78118)

When we push new commits to the girhub repo, it will tell (via a webhook) CodeBuild to start building process, which is to update the S3 bucket with a newly generated site (static files). We could set the S3 to be publicly accessible and turn on S3 web-hosting, this will allow the public to view the site via HTTP.

Instead, we don't stop here since we want to serve the site via HTTPS (for security reason), and avoid making the S3 bucket public (again for security reason). These can be done using CloudFront. CloudFront is a CDN that reads the S3 bucket and serves the contents to the public. In this way, the user has no access to the S3 bucket (they can only access what CloudFront provides), and we can use HTTPS since CloudFront support HTTPS serving.

# 2. An outline of the steps required

A very brief outline of what I did:

1. Setup a github repo for the codebase (project generated by Hugo).
2. Create an S3 bucket to host the static files built by Hugo.
3. Create a CodeBuild project that triggers the build script (I used `buildspec.yml`) on new commits to the github repo.
4. (Optional) Turn on S3 web-hosting and make the S3 bucket public, and test if the site works properly.
5. Create a CloudFront distribution with the S3 bucket as origin. You need to give CloudFront the required access right to get objects from S3. This is the hardest part of the whole project. There are many tutorials on how to do this correctly.
6. (Optional) Get a domain name and config CloudFront to use that domain name. Setup DNS using Route53. (I did not do this step)
7. Write a simple CloudFront function to handle routes correctly. (Only necessary if you are using client site routing, like what Hugo does.)
8. Your website should be up and ready.

S3 policies and scripts that I used can be found in the repo. Since every resource has a different ARN, you will need to change the resource ARN instead of plug-and-play the files into the policy editor.

# 3. Things that I end up not doing

Here is a list of things I considered but did not do, mainly because there is a cost.

- Use a CloudFormation Template to start. This is one of the standard use cases supported by CloudFormation Template, so using a template could save a lot of hassles, but building the architecture from scratch allows me to learn more. However, it is a good idea to use CloudFormation or other Infrastructure as Code (IaC) to provision the whole stack altogether. This improves deployment speed and consistency, and make the whole stack easier to manage.
- Enable security for the CloudFront distribution. This makes the site safe from the likes of DDoS attacks and more, but comes with a cost.
- Config and use a custom domain name.
- Invalidate the website cache during CodeBuild process. This makes sure the website served is always up-to-date. However, the limit for number of invalidation requests per month is quite small if you push codes often. After the limit there is a cost.
